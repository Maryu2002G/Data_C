{% extends "nav_ase.html" %}
{% load static %}
{% block titulo %} Dashboard de Cursos {% endblock %}
{% block contenido %}
<div class="container-fluid" style="padding-top: 0; margin-top: 0;">
    <!-- Bienvenida -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm text-center" style="background-color: #38A3A5; color: white;">
                <div class="card-body">
                    <h5 class="card-title">Bienvenido al Dashboard de Cursos</h5>
                    <p class="card-text">Gestiona cursos y visualiza estadísticas importantes.</p>
                    <a href="{% url 'create_course' %}" class="btn btn-light btn-lg">
                        <i class="fas fa-book-plus"></i> Agregar Curso
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Gráficos y Cursos -->
    <div class="row">
        <!-- Estadísticas de Cursos -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header" style="background-color: #22577A; color: white;">
                    <h5><i class="fas fa-chart-bar"></i> Estadísticas de Cursos</h5>
                </div>
                <div class="card-body" style="height: 200px;">
                    <canvas id="courseStatsChart" height="180"></canvas>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const ctx = document.getElementById('courseStatsChart').getContext('2d');

            const labels = {{ course_names|safe }};
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Cantidad de Estudiantes',
                    data: {{ student_counts|safe }},
                    backgroundColor: 'rgba(34, 87, 122, 0.5)',
                    borderColor: 'rgba(34, 87, 122, 1)',
                    borderWidth: 1
                }]
            };

            const config = {
                type: 'bar',  // Cambia a 'line' si prefieres un gráfico de líneas
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            const courseStatsChart = new Chart(ctx, config);
        </script>

        <!-- Acordeón de Cursos -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header" style="background-color: #80ED99; color: white;">
                    <h5><i class="fas fa-book"></i> Cursos</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #38A3A5 #f0f0f0;">
                    <!-- Input para filtro -->
                    <input type="text" id="courseFilter" class="form-control mb-3" placeholder="Filtrar por nombre de curso">

                    <!-- Acordeón de cursos -->
                    <div class="accordion" id="courseAccordion">
                        {% for cour in courses %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ cour.id }}">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ cour.id }}" aria-expanded="true" aria-controls="collapse{{ cour.id }}">
                                    {{ cour.nomCourse }}
                                </button>
                            </h2>
                            <div id="collapse{{ cour.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ cour.id }}" data-bs-parent="#courseAccordion">
                                <div class="accordion-body">
                                    <strong>Profesor:</strong> {{ cour.profesor.first_name }} {{ cour.profesor.last_name }}<br>
                                    <strong>Cantidad de Estudiantes:</strong> {{ cour.num_students }}<br>
                                    <div class="mt-3">
                                        <a class="btn btn-info btn-sm" href="{% url 'update_course' cour.id %}">
                                            <i class="fas fa-edit"></i> Actualizar
                                        </a>
                                        <a class="btn btn-danger btn-sm" href="{% url 'delete_course' cour.id %}">
                                            <i class="fas fa-trash-alt"></i> Eliminar
                                        </a>
                                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#studentsModal{{ cour.id }}">
                                            Ver Estudiantes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Modal para mostrar estudiantes -->
            {% for cour in courses %}
            <div class="modal fade" id="studentsModal{{ cour.id }}" tabindex="-1" aria-labelledby="studentsModalLabel{{ cour.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="studentsModalLabel{{ cour.id }}">{{ cour.nomCourse }} - Estudiantes</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul>
                                {% for student in cour.student_set.all %}
                                <li>{{ student.user.get_full_name }}</li>  <!-- Asumiendo que el modelo User tiene get_full_name() -->
                                {% empty %}
                                <li>No hay estudiantes inscritos en este curso.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sección Adicional (Resumen General) -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background-color: #57CC99; color: white;">
                    <h5><i class="fas fa-book-open"></i> Total de Cursos</h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="display-4">{{ courses.count }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para el gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Filtro por nombre de curso
    document.getElementById('courseFilter').addEventListener('input', function () {
        var filterValue = this.value.toLowerCase();
        var accordions = document.querySelectorAll('.accordion-item');

        accordions.forEach(function(item) {
            var header = item.querySelector('.accordion-button');
            var name = header.textContent.toLowerCase();

            if (name.includes(filterValue)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>

<style>
    /* Estilos para el scroll */
    .accordion-body::-webkit-scrollbar {
        width: 10px;
    }

    .accordion-body::-webkit-scrollbar-track {
        background: #f0f0f0; /* Color del fondo del scroll */
    }

    .accordion-body::-webkit-scrollbar-thumb {
        background-color: #38A3A5; /* Color del scroll */
        border-radius: 10px; /* Bordes redondeados */
    }

    .accordion-body::-webkit-scrollbar-thumb:hover {
        background-color: #2e7c7b; /* Color al pasar el ratón */
    }

    /* Estilos para el texto del dashboard */
    h5, .card-title, .card-text {
        font-family: 'Roboto', sans-serif; /* Asegúrate de que la fuente coincida con la del navbar */
        font-size: 16px; /* Ajusta el tamaño según lo necesites */
    }
</style>

{% endblock %}
